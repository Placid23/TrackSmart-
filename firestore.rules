
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { 
      return request.auth != null; 
    }

    function isOwner(userId) {
      return signedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return signedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    match /users/{userId} {
      // ANY signed in user can CREATE their own user doc.
      // The UID in the path must match the UID in their auth token.
      allow create: if isOwner(userId);
      
      // ANY signed in user can READ their own user doc.
      allow get: if isOwner(userId);

      // A user can UPDATE their own profile, but CANNOT make themselves an admin.
      // An admin can update any user's profile (including the isAdmin flag).
      allow update: if (isOwner(userId) && request.resource.data.isAdmin == resource.data.isAdmin) || isAdmin();

      // Only an ADMIN can LIST or DELETE users.
      allow list, delete: if isAdmin();
    }

    match /users/{userId}/transactions/{transactionId} {
      // A user can read and write their OWN transactions.
      allow read, write: if isOwner(userId);
    }

    // This collection group query allows an admin to read all transactions across all users.
    match /{path=**}/transactions/{transactionId} {
      allow read: if isAdmin();
    }
  }
}
